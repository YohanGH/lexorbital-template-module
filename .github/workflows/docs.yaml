name: üìö Documentation Generation

on:
  push:
    branches:
      - develop
      - chore/project-structure-template
    paths:
      - 'docs/**'
      - 'scripts/generate-docs.sh'
      - '.github/workflows/docs.yaml'
  workflow_dispatch: # Allow manual trigger

# Permissions explicites pour la s√©curit√©
permissions:
  contents: write  # Needed for committing generated docs
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-documentation:
    name: Generate HTML, DOCX & PDF Documentation
    runs-on: ubuntu-24.04
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # ========================================================================
      # 1. Checkout repository
      # ========================================================================
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # ========================================================================
      # 2. Create output directory
      # ========================================================================
      - name: üìÅ Create output directory
        run: mkdir -p docs/generated

      # ========================================================================
      # 3. Generate HTML documentation
      # ========================================================================
      - name: üåê Generate HTML documentation (index.html)
        run: |
          docker run --rm \
            --volume "${{ github.workspace }}:/data" \
            --workdir /data \
            pandoc/latex:3.8 \
            --standalone \
            --toc \
            --toc-depth=2 \
            --template=docs/templates/lexorbital.html \
            -H docs/templates/pandoc-styles.html \
            --metadata title="LexOrbital Module Template Guide" \
            --metadata subtitle="Complete guide for module development" \
            --metadata author="LexOrbital Core Team" \
            --metadata date="$(date '+%d %B %Y')" \
            --output=docs/generated/index.html \
            docs/README.md \
            $(find docs -maxdepth 1 -name "[0-9][0-9]_*.md" -type f | sort)

      # ========================================================================
      # 4. Generate DOCX documentation (Microsoft Word)
      # ========================================================================
      - name: üìÑ Generate DOCX documentation
        run: |
          docker run --rm \
            --volume "${{ github.workspace }}:/data" \
            --workdir /data \
            pandoc/latex:3.8 \
            --standalone \
            --toc \
            --toc-depth=2 \
            --metadata title="LexOrbital Module Template Guide" \
            --metadata subtitle="Complete guide for module development" \
            --metadata author="LexOrbital Core Team" \
            --output=docs/generated/LexOrbital_Module_Guide.docx \
            docs/README.md \
            $(find docs -maxdepth 1 -name "[0-9][0-9]_*.md" -type f | sort)

      # ========================================================================
      # 5. Generate PDF documentation (via LaTeX)
      # ========================================================================
      - name: üìï Generate PDF documentation
        run: |
          docker run --rm \
            --volume "${{ github.workspace }}:/data" \
            --workdir /data \
            pandoc/latex:3.8 \
            --standalone \
            --toc \
            --toc-depth=2 \
            --pdf-engine=xelatex \
            -V geometry:margin=1in \
            -V documentclass=report \
            -V colorlinks=true \
            -V linkcolor=blue \
            -V urlcolor=blue \
            -V toccolor=blue \
            --metadata title="LexOrbital Module Template Guide" \
            --metadata subtitle="Complete guide for module development" \
            --metadata author="LexOrbital Core Team" \
            --metadata date="$(date '+%d %B %Y')" \
            --output=docs/generated/LexOrbital_Module_Guide.pdf \
            docs/README.md \
            $(find docs -maxdepth 1 -name "[0-9][0-9]_*.md" -type f | sort)

      # ========================================================================
      # 6. Upload generated documentation as artifacts
      # ========================================================================
      - name: üì¶ Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lexorbital-documentation
          path: docs/generated/
          retention-days: 30

      # ========================================================================
      # 7. List generated files (for verification)
      # ========================================================================
      - name: ‚úÖ List generated files
        run: |
          echo "üìö Generated documentation files:"
          ls -lh docs/generated/
          echo ""
          echo "‚ú® Documentation generated successfully!"
          echo "  - index.html (HTML)"
          echo "  - LexOrbital_Module_Guide.docx (Word)"
          echo "  - LexOrbital_Module_Guide.pdf (PDF)"

      # ========================================================================
      # 8. Commit and push generated documentation
      # ========================================================================
      - name: üíæ Commit generated documentation
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/generated/
          git diff --staged --quiet || git commit -m "docs: update generated documentation [skip ci]"

      - name: üì§ Push changes
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      # ========================================================================
      # 10. Setup GitHub Pages
      # ========================================================================
      - name: ‚öôÔ∏è Setup Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/configure-pages@v5

      # ========================================================================
      # 11. Upload pages artifact
      # ========================================================================
      - name: üì§ Upload pages artifact
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs/generated

      # ========================================================================
      # 12. Deploy to GitHub Pages (only on main branch push)
      # ========================================================================
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/deploy-pages@v4

