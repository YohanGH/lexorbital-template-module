#!/usr/bin/env sh

# Trigger: At each git commit
# Actions:
#   - Validate commit message format with commitlint
#   - Enforce conventional commits (type(scope): description)
#   - Display helpful guide if validation fails
#   - Accepted formats:
#     - feat: add new feature
#     - fix(api): resolve memory leak
#     - docs: update README
#   - Block commit with invalid format
# Goal: Ensure commit messages follow a consistent format and are valid

# Exit on error, undefined variables, and pipe failures
set -euo pipefail

# Verify we are in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "‚ùå Error: Not in a git repository" >&2
  exit 1
fi

# Verify commit message file is provided
if [ -z "${1:-}" ]; then
  echo "‚ùå Error: Commit message file not provided" >&2
  exit 1
fi

# Verify commit message file exists
if [ ! -f "$1" ]; then
  echo "‚ùå Error: Commit message file '$1' does not exist" >&2
  exit 1
fi

echo "üìù Validating commit message with commitlint..."

# Execute commitlint with detailed output (prefer pnpm when available)
COMMITLINT_STATUS=0
if command -v pnpm >/dev/null 2>&1; then
  pnpm exec commitlint --edit "$1" --verbose || COMMITLINT_STATUS=$?
else
  npx --no-install commitlint --edit "$1" --verbose || COMMITLINT_STATUS=$?
fi

if [ "$COMMITLINT_STATUS" -ne 0 ]; then
  echo ""
  echo "‚ùå Commit message validation failed!"
  echo ""
  echo "üìã Valid commit types:"
  echo "  feat:     New feature"
  echo "  fix:      Bug fix"
  echo "  docs:     Documentation"
  echo "  style:    Formatting, missing semicolons, etc."
  echo "  refactor: Code refactoring"
  echo "  perf:     Performance improvement"
  echo "  test:     Adding or modifying tests"
  echo "  chore:    Maintenance, dependencies, etc."
  echo "  revert:   Reverting changes"
  echo "  ci:       CI/CD configuration"
  echo "  build:    Build system or external dependencies"
  echo ""
  echo "üìù Format: type(scope): description"
  echo "   Example: feat(auth): add user login validation"
  echo ""
  exit "$COMMITLINT_STATUS"
fi

echo "‚úÖ Commit message is valid!"
