#!/usr/bin/env sh

# Trigger: before each `git push`
# Goal: ensure branch naming, tests and lint pass

echo "ğŸš€ Running pre-push checks..."

# Check branch naming convention
branch_name="$(git rev-parse --abbrev-ref HEAD)"

pattern='^(feat|fix|chore|refactor|docs|ci|infra|security)\/[a-z0-9]+(-[a-z0-9]+)+$'

if ! echo "$branch_name" | grep -Eq "$pattern"; then
  echo "âŒ LexOrbital: invalid branch name '$branch_name'"
  echo "   Expected: <type>/<scope>-<short-desc-kebab>"
  echo "   type âˆˆ feat|fix|chore|refactor|docs|ci|infra|security"
  exit 1
fi

echo "âœ… Branch name check passed"

# Optional: ensure code is formatted before pushing
if pnpm run format:check 2>/dev/null; then
  echo "âœ… Format check passed"
elif pnpm exec prettier --check . 2>/dev/null; then
  echo "âœ… Format check passed (prettier)"
else
  echo "âš ï¸  Format check skipped (no format:check script found)"
fi

echo "ğŸ§ª Running tests..."
pnpm test
TEST_STATUS=$?

if [ $TEST_STATUS -ne 0 ]; then
  echo "âŒ Tests failed. Push aborted."
  exit $TEST_STATUS
fi

echo "ğŸ¨ Running lint..."
pnpm run lint
LINT_STATUS=$?

if [ $LINT_STATUS -ne 0 ]; then
  echo "âŒ Lint failed. Push aborted."
  exit $LINT_STATUS
fi

echo "âœ… Pre-push checks passed. Ready to push ğŸš€"
