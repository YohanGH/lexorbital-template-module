#!/usr/bin/env sh

# Trigger: At each git commit
# Duration: ~10-60 seconds
# Actions:
#   - TypeScript type checking (tsc --noEmit) if TS files modified
#   - Unit tests (vitest run) if code/test files modified
#   - Prettier formatting check on staged files
#   - ESLint with auto-fix on staged files via lint-staged
#   - Block commit if any check fails
# Goal: Quick quality filter to catch obvious errors early before CI

# Note: We use 'set -u' and 'set -o pipefail' but disable 'set -e' in loops
# to handle errors gracefully and capture exit codes properly
set -u
set -o pipefail

. "$(dirname "$0")/common.sh"

# Helper function to check if we're in a git repository
check_git_repo() {
  if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "‚ùå Error: Not in a git repository" >&2
    exit 1
  fi
}

# Helper function to run tests
run_tests() {
  if command -v pnpm >/dev/null 2>&1 && grep -q '"test"' package.json 2>/dev/null; then
    pnpm test 2>&1
  elif command -v npx >/dev/null 2>&1; then
    npx --no-install vitest run 2>&1
  else
    echo "‚ö†Ô∏è  Test runner not found - skipping tests"
    return 0
  fi
}

# Helper function to run dependency cruiser validation
run_depcruise() {
  if command -v pnpm >/dev/null 2>&1 && grep -q '"depcruise:validate"' package.json 2>/dev/null; then
    pnpm depcruise:validate 2>&1
  elif command -v npx >/dev/null 2>&1; then
    npx --no-install depcruise --config .dependency-cruiser.cjs --output-type err frontend/src backend/src config tests scripts 2>&1
  else
    echo "‚ö†Ô∏è  Dependency-cruiser not found - skipping dependency validation"
    return 0
  fi
}

check_git_repo

echo "üöÄ Running pre-commit checks..."

# Detect which files were staged for commit
echo "üîç Detecting staged files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
  echo "‚ö†Ô∏è  No files staged for commit. Skipping pre-commit checks."
  exit 0
fi

# Check if TypeScript files or code files were modified
# Use grep to check file patterns (handles spaces in filenames correctly)
TS_FILES_MODIFIED=false
CODE_MODIFIED=false

# Check for TypeScript files
if echo "$STAGED_FILES" | grep -qE '\.(ts|tsx)$'; then
  TS_FILES_MODIFIED=true
  CODE_MODIFIED=true
fi

# Check for other code files (src/, tests/, config/, or JS extensions)
if echo "$STAGED_FILES" | grep -qE '(^src/|^tests/|^config/|\.(js|jsx)$)'; then
  CODE_MODIFIED=true
fi

# If no code files were modified, skip type checking (e.g., docs-only changes)
if [ "$CODE_MODIFIED" = false ]; then
  echo "üìù No code files detected - skipping type check (docs/config only)"
  TS_FILES_MODIFIED=false
fi

# Type checking (only if TypeScript files were modified)
if [ "$TS_FILES_MODIFIED" = true ]; then
  echo "üîç Type checking TypeScript files..."

  # Try to find tsconfig.json
  TSCONFIG=""
  if [ -f "tsconfig.json" ]; then
    TSCONFIG="tsconfig.json"
  elif [ -f "tsconfig.base.json" ]; then
    TSCONFIG="tsconfig.base.json"
  fi

  if [ -n "$TSCONFIG" ]; then
    # Use npx to ensure we use the local TypeScript version
    set +e  # Disable exit on error to capture status
    npx --no-install tsc --noEmit --project "$TSCONFIG" 2>&1
    TSC_STATUS=$?
    set -e  # Re-enable exit on error

    if [ "$TSC_STATUS" -ne 0 ]; then
      echo "‚ùå TypeScript type check failed!"
      echo "   Fix type errors before committing."
      exit "$TSC_STATUS"
    fi

    echo "‚úÖ Type check passed"
  else
    echo "‚ö†Ô∏è  No tsconfig.json found - skipping type check"
  fi
else
  echo "‚è≠Ô∏è  Skipping type check (no TypeScript files modified)"
fi

# Run tests (only if code or test files were modified)
if [ "$CODE_MODIFIED" = true ]; then
  echo "üß™ Running unit tests..."

  set +e  # Disable exit on error to capture status
  run_tests
  TEST_STATUS=$?
  set -e  # Re-enable exit on error

  if [ "$TEST_STATUS" -ne 0 ]; then
    echo "‚ùå Tests failed!"
    echo "   Fix failing tests before committing."
    exit "$TEST_STATUS"
  fi

  echo "‚úÖ All tests passed"
else
  echo "‚è≠Ô∏è  Skipping tests (no code/test files modified)"
fi

# Lint-staged (ESLint + Prettier on staged files only)
echo "üé® Running lint-staged (ESLint + Prettier)..."
set +e  # Disable exit on error to capture status
npx --no-install lint-staged
LINT_STAGED_STATUS=$?
set -e  # Re-enable exit on error

if [ "$LINT_STAGED_STATUS" -ne 0 ]; then
  echo "‚ùå Lint-staged failed!"
  echo "   Some files may need manual fixes. Check the output above."
  exit "$LINT_STAGED_STATUS"
fi

# Dependency cruiser validation (only if code files were modified)
if [ "$CODE_MODIFIED" = true ]; then
  echo "üîó Running dependency-cruiser validation..."

  set +e  # Disable exit on error to capture status
  run_depcruise
  DEPCRUISE_STATUS=$?
  set -e  # Re-enable exit on error

  if [ "$DEPCRUISE_STATUS" -ne 0 ]; then
    echo "‚ùå Dependency validation failed!"
    echo "   Fix dependency violations before committing."
    exit "$DEPCRUISE_STATUS"
  fi

  echo "‚úÖ Dependency validation passed"
else
  echo "‚è≠Ô∏è  Skipping dependency validation (no code files modified)"
fi

echo "‚úÖ All pre-commit checks passed!"
